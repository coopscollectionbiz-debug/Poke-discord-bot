/**
 * /trainercard â€” Displays a userâ€™s Trainer Card (horizontal layout)
 * Ephemeral by default; reused by /sharetrainercard and /showtrainercard.
 */

import {
  SlashCommandBuilder,
  EmbedBuilder,
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle
} from 'discord.js';
import { spritePaths } from '../spriteConfig.js';
import { getRoleForTP } from '../bot_final_integrated.js';
import pokemonData from '../data/pokemonData.json' assert { type: 'json' };
import trainerSprites from '../data/trainerSprites.json' assert { type: 'json' };

const CARD_TIMEOUT = 30 * 1000;

export default {
  data: new SlashCommandBuilder()
    .setName('trainercard')
    .setDescription('View or edit your Trainer Card.'),
  async execute(interaction, trainerData) {
    const userId = interaction.user.id;
    if (!trainerData[userId])
      trainerData[userId] = { tp: 0, cc: 0, pokemon: {}, trainers: {} };

    const user = trainerData[userId];
    const trainerKey = user.selectedTrainer || Object.keys(trainerSprites)[0];
    const trainer = trainerSprites[trainerKey];
    const trainerSprite = `${spritePaths.trainers}${trainer.sprite}`;

    // get first 6 PokÃ©mon for card
    const owned = Object.keys(user.pokemon || {});
    const slots = 6;
    const shown = owned.slice(0, slots);
    const placeholders = slots - shown.length;
    const images = [];

    for (const id of shown) {
      const data = pokemonData[id];
      if (data)
        images.push(
          `[â€Ž](${data.sprite})` +
            `<:poke_${id}:${data.id || id}>` // invisible link trick for alignment
        );
    }

    for (let i = 0; i < placeholders; i++) {
      images.push(`[â€Ž](${spritePaths.items}pokeball.png)`);
    }

    const row1 = images.slice(0, 3).join(' ');
    const row2 = images.slice(3, 6).join(' ');

    const tp = user.tp || 0;
    const cc = user.cc || 0;
    const rank = getRoleForTP(tp);

    const embed = new EmbedBuilder()
      .setColor(0xffcb05)
      .setAuthor({
        name: `${interaction.user.username}'s Trainer Card`,
        iconURL: interaction.user.displayAvatarURL()
      })
      .setThumbnail(trainerSprite)
      .setDescription(
        `ðŸ… **Rank:** ${rank}\n` +
          `â­ **Trainer Points:** ${tp.toLocaleString()}\n` +
          `ðŸ’° **Coop Coins:** ${cc.toLocaleString()}\n` +
          `ðŸ¾ **PokÃ©mon Owned:** ${Object.keys(user.pokemon || {}).length}\n` +
          `ðŸ§‘â€ðŸ« **Trainers Owned:** ${Object.keys(user.trainers || {}).length}\n\n` +
          `${row1}\n${row2}`
      )
      .setFooter({
        text: `You can edit your displayed trainer or PokÃ©mon for ${CARD_TIMEOUT /
          1000}s.`
      });

    // Buttons for edit preview
    const row = new ActionRowBuilder().addComponents(
      new ButtonBuilder()
        .setCustomId('confirm_edit')
        .setLabel('ðŸ–‹ Edit Display')
        .setStyle(ButtonStyle.Primary),
      new ButtonBuilder()
        .setCustomId('cancel_edit')
        .setLabel('âŒ Cancel')
        .setStyle(ButtonStyle.Secondary)
    );

    const msg = await interaction.reply({
      embeds: [embed],
      components: [row],
      ephemeral: true
    });

    // collector for confirm/cancel
    const collector = msg.createMessageComponentCollector({
      time: CARD_TIMEOUT
    });

    collector.on('collect', async (i) => {
      if (i.user.id !== userId)
        return i.reply({ content: 'Not your card!', ephemeral: true });

      if (i.customId === 'confirm_edit') {
        await i.update({
          content:
            'âœï¸ Trainer Card editing coming soon â€” customization will include trainer and PokÃ©mon selection.',
          components: [],
          embeds: []
        });
      } else if (i.customId === 'cancel_edit') {
        await i.update({
          content: 'âŒ Trainer Card editing cancelled.',
          components: [],
          embeds: []
        });
      }
    });

    collector.on('end', async () => {
      try {
        await msg.edit({ components: [] });
      } catch {}
    });
  }
};
